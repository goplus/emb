name: Validate Device Sync

on:
  push:
    branches:
      - device
  pull_request:
    branches:
      - device

env:
  TINYGO_VERSION: v0.39.0

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit message format
        if: github.event_name == 'push'
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"
          
          if ! echo "$COMMIT_MSG" | grep -qE '^\[SYNC\] Update device to TinyGo v[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "Error: Commit message must follow format: [SYNC] Update device to TinyGo <version>"
            echo "Example: [SYNC] Update device to TinyGo v0.39.0"
            exit 1
          fi
          
          echo "✓ Commit message format is valid"

      - name: Sync device content from TinyGo release
        run: |
          chmod +x .github/scripts/sync-from-release.sh
          ./.github/scripts/sync-from-release.sh ${{ env.TINYGO_VERSION }} src/device device-temp

      - name: Compare synced content with repository
        run: |
          echo "Comparing device-temp/ with device/..."
          
          if ! diff -r device/ device-temp/; then
            echo ""
            echo "Error: device/ directory does not match TinyGo ${{ env.TINYGO_VERSION }} official content"
            echo "Please run: ./.github/scripts/sync-from-release.sh ${{ env.TINYGO_VERSION }} src/device device"
            exit 1
          fi
          
          echo "✓ Device content matches TinyGo ${{ env.TINYGO_VERSION }} release"

      - name: Validation Summary
        if: success()
        run: |
          echo "================================"
          echo "✓ All validations passed!"
          echo "================================"
          echo "- Commit message format: valid"
          echo "- Device content sync: verified"
          echo "- TinyGo version: ${{ env.TINYGO_VERSION }}"
          echo "================================"
